<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formation Entrepreneuriat - Leçon</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="formation-layout">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">KJ</div>
                    <div class="user-details">
                        <h3 id="userName">Kevin JEAN</h3>
                        <p>Étudiant</p>
                    </div>
                </div>
                <div class="progress-info">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Progression</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <nav class="navigation" id="navigation">
                <!-- Navigation will be generated by JavaScript -->
            </nav>

            <div style="padding: 20px;">
                <button onclick="logout()" style="width: 100%; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    Déconnexion
                </button>
            </div>
        </div>

        <!-- Contenu principal -->
        <div class="main-content">
            <div class="content-header">
                <h1 class="content-title" id="lessonTitle">Titre de la leçon</h1>
                <p class="content-subtitle" id="moduleTitle">Module X</p>
            </div>

            <!-- Navigation de leçon -->
            <div class="lesson-nav">
                <button class="nav-button prev" id="prevButton" onclick="previousLesson()">
                    ← Précédent
                </button>
                
                <button class="complete-button" id="completeButton" onclick="markAsCompleted()">
                    Marquer comme terminé
                </button>
                
                <button class="nav-button next" id="nextButton" onclick="nextLesson()">
                    Suivant →
                </button>
            </div>

            <!-- Contenu de la leçon -->
            <div class="lesson-content" id="lessonContent">
                <!-- Le contenu sera chargé dynamiquement -->
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script src="lesson-content-module1.js"></script>
    <script src="lesson-content-module2.js"></script>
    <script src="lesson-content-module3.js"></script>
    <script src="lesson-content-module4.js"></script>
    <script src="lesson-content-module5.js"></script>
    <script src="lesson-content-module6.js"></script>
    <script src="lesson-content-module7.js"></script>
    <script src="lesson-content-module8.js"></script>
    <script src="lesson-content-module9.js"></script>
    <script src="lesson-content-module10.js"></script>
    <script src="lesson-content-module11.js"></script>
    <script src="lesson-content-module12.js"></script>
    <script src="lesson-content-module13.js"></script>
    <script>
        // Variables globales pour la leçon actuelle (AVANT toute autre fonction)
        let currentModule = parseInt(getUrlParameter('module')) || 1;
        let currentLesson = parseInt(getUrlParameter('lesson')) || 1;
        
        // Fonction utilitaire déplacée en haut
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        // Attendre que tous les scripts soient chargés
        window.addEventListener('load', function() {
            console.log('Tous les scripts chargés, initialisation...');
            
            // Debug: vérifier les modules chargés
            console.log('Modules disponibles:', {
                module1Content: typeof window.module1Content,
                module2Content: typeof window.module2Content,
                module3Content: typeof window.module3Content,
                module4Content: typeof window.module4Content,
                module5Content: typeof window.module5Content
            });
            
            console.log('Variables globales:', {
                currentModule: currentModule,
                currentLesson: currentLesson
            });
            
            // Vérifier l'authentification
            checkAuth();
            
            // Initialiser la leçon
            initializeLesson();
        });
        
        function initializeLesson() {
            console.log(`Initialisation leçon: Module ${currentModule}, Leçon ${currentLesson}`);
            
            // Charger la navigation
            generateNavigation();
            
            // Charger le contenu de la leçon
            loadLessonContent();
            
            // Mettre à jour l'état des boutons
            updateNavigationButtons();
            
            // Mettre à jour la progression
            updateProgress();
        }
        
        function loadLessonContent() {
            console.log('Chargement du contenu...');
            
            const lesson = getLessonData(currentModule, currentLesson);
            console.log('Données de la leçon récupérées:', lesson);
            
            if (lesson && lesson.content && lesson.content.trim().length > 0) {
                console.log('Affichage du contenu...');
                document.getElementById('lessonTitle').textContent = lesson.title;
                document.getElementById('moduleTitle').textContent = lesson.moduleTitle;
                document.getElementById('lessonContent').innerHTML = lesson.content;
            } else {
                console.error('Aucun contenu trouvé pour cette leçon');
                document.getElementById('lessonTitle').textContent = 'Erreur de chargement';
                document.getElementById('moduleTitle').textContent = `Module ${currentModule}`;
                document.getElementById('lessonContent').innerHTML = `
                    <h1>Contenu non trouvé</h1>
                    <p>Impossible de charger le contenu pour le module ${currentModule}, leçon ${currentLesson}.</p>
                    <div style="background: #f8d7da; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <h4>Informations de debug :</h4>
                        <ul>
                            <li>Module demandé : ${currentModule}</li>
                            <li>Leçon demandée : ${currentLesson}</li>
                            <li>window.module${currentModule}Content existe : ${typeof window['module' + currentModule + 'Content']}</li>
                        </ul>
                    </div>
                `;
            }
        }
        
        function markAsCompleted() {
            const lessonKey = `module_${currentModule}_lesson_${currentLesson}`;
            
            // Marquer comme terminé dans le localStorage
            let progress = JSON.parse(localStorage.getItem('lessonProgress') || '{}');
            progress[lessonKey] = {
                completed: true,
                completedAt: new Date().toISOString()
            };
            localStorage.setItem('lessonProgress', JSON.stringify(progress));
            
            // Envoyer les données au serveur
            sendProgressToServer();
            
            // Mettre à jour l'interface
            updateProgress();
            generateNavigation();
            
            // Changer le bouton
            const completeButton = document.getElementById('completeButton');
            completeButton.textContent = '✓ Terminé';
            completeButton.style.background = '#28a745';
            completeButton.disabled = true;
            
            // Notification
            showNotification('Leçon marquée comme terminée !');
        }
        
        function previousLesson() {
            const prevLesson = getPreviousLesson(currentModule, currentLesson);
            if (prevLesson) {
                if (prevLesson.isPDF) {
                    window.location.href = `pdf-downloads.html?module=${prevLesson.module}&lesson=${prevLesson.lesson}`;
                } else {
                    window.location.href = `lesson.html?module=${prevLesson.module}&lesson=${prevLesson.lesson}`;
                }
            }
        }
        
        function nextLesson() {
            const nextLesson = getNextLesson(currentModule, currentLesson);
            if (nextLesson) {
                if (nextLesson.isPDF) {
                    window.location.href = `pdf-downloads.html?module=${nextLesson.module}&lesson=${nextLesson.lesson}`;
                } else {
                    window.location.href = `lesson.html?module=${nextLesson.module}&lesson=${nextLesson.lesson}`;
                }
            }
        }
        
        function updateNavigationButtons() {
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');
            const completeButton = document.getElementById('completeButton');
            
            // Vérifier si la leçon est déjà terminée
            const lessonKey = `module_${currentModule}_lesson_${currentLesson}`;
            const progress = JSON.parse(localStorage.getItem('lessonProgress') || '{}');
            const isCompleted = progress[lessonKey] && progress[lessonKey].completed;
            
            // Réinitialiser le bouton
            completeButton.textContent = 'Marquer comme terminé';
            completeButton.style.background = '#007bff';
            completeButton.disabled = false;
            
            if (isCompleted) {
                completeButton.textContent = '✓ Terminé';
                completeButton.style.background = '#28a745';
                completeButton.disabled = true;
            }
            
            // Gérer les boutons de navigation
            const prevLesson = getPreviousLesson(currentModule, currentLesson);
            const nextLesson = getNextLesson(currentModule, currentLesson);
            
            if (!prevLesson) {
                prevButton.disabled = true;
                prevButton.style.display = 'none';
            } else {
                prevButton.disabled = false;
                prevButton.style.display = 'block';
            }
            
            if (!nextLesson) {
                nextButton.disabled = true;
                nextButton.style.display = 'none';
            } else {
                nextButton.disabled = false;
                nextButton.style.display = 'block';
            }
        }
        
        function showNotification(message) {
            // Créer une notification temporaire
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 20px;
                border-radius: 6px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }
        
        function downloadPDF(filename) {
            // Créer le téléchargement de PDF
            const link = document.createElement('a');
            link.href = `assets/pdf/${filename}`;
            link.download = filename;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Téléchargement en cours...');
        }
        
        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('username');
            localStorage.removeItem('loginTime');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>